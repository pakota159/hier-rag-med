# Enhanced Basic Reasoning System GPU Configuration (RunPod/CUDA)
# Hierarchical Medical Q&A optimized for GPU evaluation and MIRAGE benchmark

# Environment
environment: "gpu"
platform: "runpod"

# Data directory
data_dir: data/foundation

# GPU-optimized model configurations
models:
  embedding:
    name: sentence-transformers/all-MiniLM-L6-v2
    device: cuda
    batch_size: 64  # Higher for GPU
    max_length: 512
    normalize_embeddings: true
    trust_remote_code: false
    # GPU optimizations
    mixed_precision: true
    compile_model: true
  
  llm:
    name: mistral:7b-instruct
    device: cuda
    temperature: 0.2  # Lower for more consistent medical Q&A answers
    context_window: 4096
    max_new_tokens: 512
    # GPU optimizations
    batch_size: 32
    mixed_precision: true
    use_flash_attention: true

# GPU-optimized hierarchical retrieval with enhanced medical focus
hierarchical_retrieval:
  tier1_top_k: 8        # Pattern Recognition - more results on GPU
  tier2_top_k: 6        # Clinical Reasoning - increased for better coverage
  tier3_top_k: 4        # Evidence Confirmation - more evidence
  enable_evidence_stratification: true
  enable_temporal_weighting: true
  medical_specialty_boost: true  # Boost specialty-matched content
  # GPU-specific settings
  batch_size: 64
  parallel_processing: true
  num_workers: 4
  pin_memory: true

# GPU-optimized processing for medical content
processing:
  chunk_size: 512
  chunk_overlap: 100
  min_content_length: 50  # Ensure meaningful medical content
  enable_medical_entity_recognition: true
  # GPU batch processing
  batch_size: 128
  num_workers: 4
  pin_memory: true

# Enhanced prompts for medical multiple choice questions (GPU optimized)
prompts:
  system: |
    You are a medical knowledge expert answering multiple choice questions.
    Analyze each question systematically using hierarchical medical reasoning.
    
    CRITICAL REQUIREMENTS:
    - Select ONLY ONE answer: A, B, C, D, or E
    - Format your final answer as: "Answer: [LETTER]"
    - Base your answer on medical evidence and established knowledge
    - Be precise, accurate, and evidence-based
    - Keep responses concise for GPU efficiency
    
    RESPONSE FORMAT:
    1. Brief analysis of the question topic
    2. Systematic evaluation of key options
    3. Selection of the best answer
    4. Final answer: "Answer: [LETTER]"
    
    EXAMPLE:
    Question: What is the most common cause of community-acquired pneumonia?
    Options: A) Mycoplasma B) Streptococcus pneumoniae C) Haemophilus influenzae D) Staphylococcus aureus
    
    Analysis: Community-acquired pneumonia etiology varies by population and setting. S. pneumoniae remains the leading bacterial cause in most populations, particularly in adults without comorbidities.
    
    Answer: B
    
  tier1_prompt: |
    TIER 1 - MEDICAL PATTERN RECOGNITION:
    Analyze the basic medical concepts, definitions, anatomy, and fundamental knowledge patterns.
    
    Focus areas:
    • Medical terminology and definitions
    • Basic anatomy and physiology
    • Fundamental disease concepts
    • Clinical presentations and symptoms
    • Basic classifications and categories
    
    Use this foundational knowledge to understand what the question is asking about.
    
  tier2_prompt: |
    TIER 2 - CLINICAL REASONING:
    Apply clinical knowledge, pathophysiology, and diagnostic reasoning.
    
    Focus areas:
    • Disease mechanisms and pathophysiology
    • Clinical decision-making processes
    • Diagnostic criteria and differential diagnosis
    • Treatment principles and management approaches
    • Risk factors and prognostic indicators
    
    Use this clinical knowledge to systematically evaluate each answer option.
    
  tier3_prompt: |
    TIER 3 - EVIDENCE-BASED CONFIRMATION:
    Confirm with established medical facts, guidelines, and research evidence.
    
    Focus areas:
    • Clinical practice guidelines (WHO, AHA, ESC, etc.)
    • Evidence-based medicine and research findings
    • Established medical standards and protocols
    • Authoritative medical recommendations
    • Definitive diagnostic and treatment criteria
    
    Use this authoritative knowledge to select the most accurate answer.

# Web interface (GPU optimized)
web:
  host: 0.0.0.0
  port: 8503
  cors_origins: ["*"]
  # GPU-specific web settings
  max_concurrent_requests: 16
  request_timeout: 120
  enable_gpu_monitoring: true

# Enhanced evaluation settings for GPU
evaluation:
  enable_answer_extraction: true
  answer_validation_strict: true
  require_final_answer_format: true
  log_reasoning_steps: true
  # GPU-specific evaluation settings
  batch_evaluation: true
  parallel_processing: true
  gpu_memory_optimization: true
  benchmark_optimization: "mirage"  # Optimize for MIRAGE benchmark

# GPU performance monitoring
gpu_monitoring:
  enable_memory_tracking: true
  enable_utilization_tracking: true
  log_interval_seconds: 30
  memory_warning_threshold: 0.9
  temperature_warning_threshold: 80